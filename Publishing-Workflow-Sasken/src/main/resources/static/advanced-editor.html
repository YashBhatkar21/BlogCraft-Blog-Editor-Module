<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Blog Editor - BlogCraft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .toolbar-button { transition: all 0.2s; }
        .toolbar-button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .media-preview { transition: all 0.3s; }
        .media-preview:hover { transform: scale(1.02); }
        .ql-editor { min-height: 400px; }
        .ql-toolbar { border-radius: 8px 8px 0 0; }
        .ql-container { border-radius: 0 0 8px 8px; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                    </div>
                    <span class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        BlogCraft Pro
                    </span>
                </div>
                <nav class="hidden md:flex gap-8 text-sm font-medium">
                    <a href="index.html" class="text-gray-700 hover:text-blue-600 transition-colors duration-200">Home</a>
                    <a href="advanced-editor.html" class="text-blue-600 font-semibold">Advanced Editor</a>
                    <a href="drafts.html" class="text-gray-700 hover:text-blue-600 transition-colors duration-200">Drafts</a>
                    <a href="dashboard.html" class="text-gray-700 hover:text-blue-600 transition-colors duration-200">Dashboard</a>
                    <a href="posts.html" class="text-gray-700 hover:text-blue-600 transition-colors duration-200">All Posts</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <!-- Left Sidebar - Tools -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Author Section -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-user-edit text-blue-600"></i>
                        Author Details
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Author Name</label>
                            <input type="text" id="authorName" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Your name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                            <textarea id="authorBio" rows="3" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Brief author bio"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Media Library -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-images text-green-600"></i>
                        Media Library
                    </h3>
                    <div class="space-y-4">
                        <button onclick="openMediaUpload()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 px-4 rounded-lg font-medium hover:from-green-600 hover:to-emerald-700 transition-all duration-200 flex items-center justify-center gap-2">
                            <i class="fas fa-upload"></i>
                            Upload Media
                        </button>
                        <div id="mediaLibrary" class="space-y-3 max-h-64 overflow-y-auto">
                            <!-- Media items will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- SEO Tools -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-search text-purple-600"></i>
                        SEO Tools
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Meta Title</label>
                            <input type="text" id="metaTitle" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="SEO title">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Meta Description</label>
                            <textarea id="metaDescription" rows="3" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="SEO description"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Keywords</label>
                            <input type="text" id="keywords" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="keyword1, keyword2, keyword3">
                        </div>
                    </div>
                </div>

                <!-- Publishing Options -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-cog text-orange-600"></i>
                        Publishing
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <select id="category" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Select Category</option>
                                <option value="technology">Technology</option>
                                <option value="lifestyle">Lifestyle</option>
                                <option value="business">Business</option>
                                <option value="health">Health</option>
                                <option value="travel">Travel</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
                            <input type="text" id="tags" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="tag1, tag2, tag3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Featured Image</label>
                            <div id="featuredImagePreview" class="w-full h-32 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center cursor-pointer hover:border-blue-400 transition-colors">
                                <div class="text-center text-gray-500">
                                    <i class="fas fa-image text-2xl mb-2"></i>
                                    <p class="text-sm">Click to select</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Editor Area -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Post Title -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Post Title</label>
                        <input type="text" id="postTitle" class="w-full text-3xl font-bold p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your compelling headline...">
                    </div>
                    <div class="flex items-center gap-4 text-sm text-gray-500">
                        <span><i class="fas fa-clock mr-1"></i> <span id="readingTime">0 min read</span></span>
                        <span><i class="fas fa-eye mr-1"></i> <span id="wordCount">0 words</span></span>
                        <span><i class="fas fa-calendar mr-1"></i> <span id="currentDate"></span></span>
                    </div>
                </div>

                <!-- Rich Text Editor -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Content Editor</h3>
                        <p class="text-sm text-gray-600">Use the toolbar below to format your content</p>
                    </div>
                    <div id="editor" class="min-h-[500px]"></div>
                </div>

                <!-- Action Buttons -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button onclick="saveDraft()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-4 rounded-xl font-semibold transition-all duration-200 flex items-center justify-center gap-2">
                            <i class="fas fa-save"></i>
                            Save Draft
                        </button>
                        <button onclick="previewPost()" class="flex-1 bg-blue-100 hover:bg-blue-200 text-blue-700 px-6 py-4 rounded-xl font-semibold transition-all duration-200 flex items-center justify-center gap-2">
                            <i class="fas fa-eye"></i>
                            Preview
                        </button>
                        <button onclick="publishPost()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-6 py-4 rounded-xl font-semibold transition-all duration-200 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105">
                            <i class="fas fa-paper-plane"></i>
                            Publish
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Media Upload Modal -->
    <div id="mediaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-gray-900">Upload Media</h3>
                        <button onclick="closeMediaModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 space-y-6">
                    <!-- File Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select File</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors cursor-pointer" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">Click to select or drag and drop</p>
                            <p class="text-sm text-gray-500 mt-1">Supports: JPG, PNG, GIF, MP4, AVI, PDF</p>
                        </div>
                        <input type="file" id="fileInput" class="hidden" accept="image/*,video/*,.pdf,.doc,.docx" onchange="handleFileSelect(event)">
                    </div>

                    <!-- File Preview -->
                    <div id="filePreview" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
                        <div id="previewContainer" class="border border-gray-200 rounded-lg p-4"></div>
                    </div>

                    <!-- Media Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Alt Text</label>
                            <input type="text" id="altText" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Describe the media for accessibility">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Caption</label>
                            <input type="text" id="caption" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Optional caption">
                        </div>
                    </div>

                    <!-- Upload Button -->
                    <div class="flex gap-3">
                        <button onclick="closeMediaModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-lg font-medium transition-colors">
                            Cancel
                        </button>
                        <button onclick="uploadMedia()" id="uploadBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-upload mr-2"></i>
                            Upload
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Quill editor
        let quill;
        let currentBlogPostId = null;
        let selectedFile = null;

        document.addEventListener('DOMContentLoaded', function() {
            initializeEditor();
            updateCurrentDate();
            setInterval(updateWordCount, 1000);
        });

        function initializeEditor() {
            const toolbarOptions = [
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'font': [] }],
                [{ 'size': ['small', false, 'large', 'huge'] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'script': 'sub'}, { 'script': 'super' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }],
                [{ 'direction': 'rtl' }],
                [{ 'align': [] }],
                ['blockquote', 'code-block'],
                ['link', 'image', 'video'],
                ['clean']
            ];

            quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: toolbarOptions
                },
                placeholder: 'Start writing your amazing blog post...'
            });

            // Add custom image handler
            quill.getModule('toolbar').addHandler('image', function() {
                openMediaUpload();
            });

            // Add custom video handler
            quill.getModule('toolbar').addHandler('video', function() {
                openMediaUpload();
            });
        }

        function updateCurrentDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString();
        }

        function updateWordCount() {
            const text = quill.getText();
            const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
            const readingTime = Math.ceil(words / 200); // Average reading speed
            
            document.getElementById('wordCount').textContent = `${words} words`;
            document.getElementById('readingTime').textContent = `${readingTime} min read`;
        }

        function openMediaUpload() {
            document.getElementById('mediaModal').classList.remove('hidden');
        }

        function closeMediaModal() {
            document.getElementById('mediaModal').classList.add('hidden');
            resetMediaForm();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                showFilePreview(file);
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        function showFilePreview(file) {
            const previewContainer = document.getElementById('previewContainer');
            const filePreview = document.getElementById('filePreview');
            
            filePreview.classList.remove('hidden');
            previewContainer.innerHTML = '';

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'max-w-full h-auto rounded-lg';
                previewContainer.appendChild(img);
            } else if (file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                video.controls = true;
                video.className = 'max-w-full h-auto rounded-lg';
                previewContainer.appendChild(video);
            } else {
                const div = document.createElement('div');
                div.className = 'p-4 bg-gray-100 rounded-lg text-center';
                div.innerHTML = `<i class="fas fa-file text-3xl text-gray-400 mb-2"></i><p class="text-gray-600">${file.name}</p>`;
                previewContainer.appendChild(div);
            }
        }

        function resetMediaForm() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('altText').value = '';
            document.getElementById('caption').value = '';
            document.getElementById('filePreview').classList.add('hidden');
            document.getElementById('uploadBtn').disabled = true;
        }

        async function uploadMedia() {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('altText', document.getElementById('altText').value);
            formData.append('caption', document.getElementById('caption').value);

            try {
                const response = await fetch('/api/media/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const media = await response.json();
                    insertMediaIntoEditor(media);
                    closeMediaModal();
                    loadMediaLibrary();
                } else {
                    alert('Upload failed. Please try again.');
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed. Please try again.');
            }
        }

        function insertMediaIntoEditor(media) {
            const range = quill.getSelection();
            if (media.fileType === 'image') {
                quill.insertEmbed(range.index, 'image', media.fileUrl);
            } else if (media.fileType === 'video') {
                quill.insertEmbed(range.index, 'video', media.fileUrl);
            }
            quill.setSelection(range.index + 1);
        }

        async function loadMediaLibrary() {
            try {
                const response = await fetch('/api/media/recent/images');
                const images = await response.json();
                
                const mediaLibrary = document.getElementById('mediaLibrary');
                mediaLibrary.innerHTML = '';

                images.forEach(media => {
                    const mediaItem = document.createElement('div');
                    mediaItem.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors';
                    mediaItem.onclick = () => insertMediaIntoEditor(media);
                    
                    mediaItem.innerHTML = `
                        <img src="${media.thumbnailPath || media.fileUrl}" alt="${media.altText}" class="w-12 h-12 object-cover rounded">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${media.originalFileName}</p>
                            <p class="text-xs text-gray-500">${formatFileSize(media.fileSize)}</p>
                        </div>
                    `;
                    
                    mediaLibrary.appendChild(mediaItem);
                });
            } catch (error) {
                console.error('Error loading media library:', error);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function saveDraft() {
            const postData = {
                title: document.getElementById('postTitle').value,
                content: quill.getText(),
                richContent: quill.root.innerHTML,
                authorName: document.getElementById('authorName').value,
                status: 'DRAFT'
            };

            try {
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postData)
                });

                if (response.ok) {
                    const savedPost = await response.json();
                    currentBlogPostId = savedPost.id;
                    alert('Draft saved successfully!');
                } else {
                    alert('Failed to save draft.');
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save draft.');
            }
        }

        function previewPost() {
            // Create a preview window with the formatted content
            const previewWindow = window.open('', '_blank');
            const content = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${document.getElementById('postTitle').value}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
                        h1 { color: #1f2937; margin-bottom: 20px; }
                        .content { color: #374151; }
                    </style>
                </head>
                <body>
                    <h1>${document.getElementById('postTitle').value}</h1>
                    <div class="content">${quill.root.innerHTML}</div>
                </body>
                </html>
            `;
            previewWindow.document.write(content);
            previewWindow.document.close();
        }

        async function publishPost() {
            if (!currentBlogPostId) {
                alert('Please save as draft first before publishing.');
                return;
            }

            try {
                const response = await fetch(`/api/posts/${currentBlogPostId}/status?status=REVIEW&userId=1`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    alert('Post submitted for review!');
                    window.location.href = 'posts.html';
                } else {
                    alert('Failed to submit for review.');
                }
            } catch (error) {
                console.error('Publish error:', error);
                alert('Failed to submit for review.');
            }
        }

        // Load media library on page load
        loadMediaLibrary();
    </script>
</body>
</html>
